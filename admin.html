<!DOCTYPE html>
<html lang="ja">
    <script>
  // --- ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ ---
  (function(){
    const current = JSON.parse(localStorage.getItem("currentUser") || "{}");
    const approved = JSON.parse(localStorage.getItem("approvedUsers") || "[]");
    const adminEmail = "admin@example.com"; // ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä»»æ„å¤‰æ›´å¯ï¼‰

    const isAdmin = approved.some(u => u.email === adminEmail) && current.email === adminEmail;

    if (!isAdmin) {
      alert("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚");
      location.href = "index.html";
    }
  })();
</script>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†è€…æ‰¿èª | æ²ç¤ºæ¿</title>
  <link rel="stylesheet" href="style/base.css" />
  <link rel="stylesheet" href="style/board-modern.css" />
  <style>
    main { max-width: 900px; margin: 0 auto; padding: 16px; }
    .admin-card { background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,.1); padding:16px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .toolbar .left { display:flex; gap:8px; align-items:center; }
    .search { max-width:280px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid var(--border); text-align:left; }
    th { font-weight:600; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-size:.8rem; }
    .btn { padding:8px 10px; border-radius:6px; border:1px solid var(--border); background:#fff; cursor:pointer; transition:transform .1s ease, box-shadow .15s ease; }
    .btn:hover { transform: translateY(-1px); box-shadow:0 2px 5px rgba(0,0,0,.12);}
    .btn:active { transform: translateY(1px);}
    .btn.approve { background: var(--accent); color:#fff; border:none; }
    .btn.reject { background: #fff; color:#b91c1c; border:1px solid #fecaca; }
    .empty { color:#666; padding:24px 8px; text-align:center; }
  </style>
</head>
<body>
  <header class="header">
    <h1>ç®¡ç†è€…æ‰¿èª</h1>
    <nav>
      <a href="index.html">ğŸ  æ²ç¤ºæ¿</a>
      <a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>
    </nav>
  </header>

  <main>
    <div class="admin-card">
      <div class="toolbar">
        <div class="left">
          <span class="badge">æ‰¿èªå¾…ã¡ä¸€è¦§</span>
          <button class="btn" id="reloadBtn">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
          <button class="btn approve" id="approveAllBtn">âœ“ ã™ã¹ã¦æ‰¿èª</button>
        </div>
        <input type="search" id="search" class="search" placeholder="åå‰ / ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢" />
      </div>

      <table aria-label="æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼">
        <thead>
          <tr>
            <th>åå‰</th>
            <th>ãƒ¡ãƒ¼ãƒ«</th>
            <th>ç”³è«‹æ—¥æ™‚</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="pendingTbody"></tbody>
      </table>
      <div id="emptyState" class="empty" style="display:none;">æ‰¿èªå¾…ã¡ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </main>

  <script>
    // ===============================
    // admin.html å†…éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ç›®çš„: æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§/æ‰¿èª/å´ä¸‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ“¬ä¼¼ï¼‰
    // ===============================

    const tbody = document.getElementById('pendingTbody');
    const emptyState = document.getElementById('emptyState');
    const search = document.getElementById('search');

    function loadPending() {
      const raw = localStorage.getItem('pendingUsers');
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function savePending(arr){ localStorage.setItem('pendingUsers', JSON.stringify(arr)); }

    function loadApproved(){
      const raw = localStorage.getItem('approvedUsers');
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function saveApproved(arr){ localStorage.setItem('approvedUsers', JSON.stringify(arr)); }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function render(list){
      tbody.innerHTML = '';
      if (!list.length){
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      tbody.innerHTML = list.map(u => `
        <tr>
          <td>${escapeHtml(u.name)}</td>
          <td>${escapeHtml(u.email)}</td>
          <td>${new Date(u.createdAt).toLocaleString()}</td>
          <td>
            <button class="btn approve" data-act="approve" data-email="${encodeURIComponent(u.email)}">æ‰¿èª</button>
            <button class="btn reject" data-act="reject" data-email="${encodeURIComponent(u.email)}">å´ä¸‹</button>
          </td>
        </tr>`).join('');
    }

    function refresh(){
      const q = search.value.trim().toLowerCase();
      const list = loadPending().filter(u => {
        if (!q) return true;
        return (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q);
      });
      render(list);
    }

    // å€‹åˆ¥æ‰¿èª/å´ä¸‹
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const act = btn.dataset.act;
      const email = decodeURIComponent(btn.dataset.email);
      let pending = loadPending();
      const idx = pending.findIndex(u => u.email === email);
      if (idx === -1) { alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      const user = pending[idx];

      if (act === 'approve'){
        const approved = loadApproved();
        approved.push({ name:user.name, email:user.email, password:user.password, approvedAt:new Date().toISOString() });
        saveApproved(approved);

        // äº’æ›ï¼šå¾“æ¥ã® login.html å‘ã‘ï¼ˆå˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜ï¼‰
        localStorage.setItem('userProfile', JSON.stringify({ name:user.name, email:user.email, password:user.password }));

        pending.splice(idx,1);
        savePending(pending);
        alert(`æ‰¿èªã—ã¾ã—ãŸ: ${user.name}`);
        refresh();

      } else if (act === 'reject'){
        if (!confirm(`å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ\n${user.name} <${user.email}>`)) return;
        pending.splice(idx,1);
        savePending(pending);
        refresh();
      }
    });

    // æ¤œç´¢/å†èª­ã¿è¾¼ã¿/ä¸€æ‹¬æ‰¿èª
    document.getElementById('reloadBtn').addEventListener('click', refresh);
    search.addEventListener('input', refresh);

    document.getElementById('approveAllBtn').addEventListener('click', () => {
      const pending = loadPending();
      if (!pending.length) return alert('æ‰¿èªå¾…ã¡ã¯ã‚ã‚Šã¾ã›ã‚“');
      if (!confirm(`å…¨${pending.length}ä»¶ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`)) return;

      const approved = loadApproved();
      pending.forEach(user => {
        approved.push({ name:user.name, email:user.email, password:user.password, approvedAt:new Date().toISOString() });
      });
      saveApproved(approved);

      // äº’æ›ï¼šæœ€å¾Œã®1ä»¶ã‚’ userProfile ã«ã‚‚ä¿å­˜
      const last = pending[pending.length-1];
      if (last) localStorage.setItem('userProfile', JSON.stringify({ name:last.name, email:last.email, password:last.password }));

      savePending([]);
      refresh();
      alert('ã™ã¹ã¦æ‰¿èªã—ã¾ã—ãŸ');
    });

    // åˆæœŸè¡¨ç¤º
    refresh();
  </script>
</body>
</html>